# 第二层到第三层



### 第一层（物理层）



### 第二层（数据链路层）

> 需要解决三个问题：
>
> 1. 这个包是发个谁的？谁应该接受？
> 2. 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？
> 3. 如果发送的时候出现了错位，怎么办？

*第二层网络包格式：*

![](D:\project\blog_image\8072e4885b0cbc6cb5384ea84d487e41.jpg)



> 这个包是发个谁的？谁应该接受？

*对于第一个问题：第二层网络包格式，就含有目标的MAC地址和源的MAC地址。*

*但是这里还有一个问题，如果不知道目标的MAC地址呢？*

**ARP协议**：已知IP地址，求MAC地址。通过广播寻找MAC地址，然后缓存下来。



> 大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？

*MAC（Medium Access Control），即媒体访问控制。控制在往媒体上发数据的时候，谁先发、谁后发的问题，防止发生混乱。这个问题中的规则，学名叫多路访问。这解决了第二个问题。*

*有三种实现方式：*

1. **信道划分**：分多个车道，每个车道，你走你的，我走我的。
2. __轮流协议__：今天单号出行，明天双号出现，轮着来。
3. __随机接入协议__：不管三七二十一，先出门，发现特堵，就回去，错过高峰再出。著名的以太网，用的就是这个方式。



> 如果发送的时候出现了错位，怎么办？

第二层网络包格式最后面的 **CRC（循环冗余检查）**，通过XOR异或的算法，来计算整个包是否在发送的过程中出现了错误。



### 局域网

**交换机**：拥有MAC地址学习能力，学完记住后，就可以不需要使用广播了。



## 交换机和LAN



### 拓扑结构



### 环路问题



### STP协议

**最小生成树**：解决环路问题



### 如何解决广播问题和安全问题？

1. **物理隔离**：每个部门使用单独的交换机，配置单独的子网。
2. **虚拟隔离**：也就是VLAN，或者叫虚拟局域网。



## ICMP与ping



### ICMP

*ICMP（Internet Control Message Protocol），互联网控制报文协议。*

* **查询报文类型**：是一种主动请求，并且获得主动应答的ICMP协议。最重要字段的有两个，**类型字段** 和 **顺序号**。 
* **差错报文类型**：
  1. *终点不可达*
  2. *源站抑制*
  3. *时间超时*
  4. *路由重定向*



### ping

*ping 使用的就是查询报文*



### Traceroute：差错报文类型的使用

1. *故意设置特殊的TTL，来追踪去往目的地时沿途经过的路由器。*

2. *故意设置不分片，从而请确定路径的MTU。*

   

## 世界这么大，我想出网关

*MAC头和IP头细节：*

<img src="D:\project\blog_image\3647ac6b516df3226ac5c6c2c731f1b0.jpg" alt="mac and ip" style="zoom:12%;" />

用CIDR和子网掩码就可以判断是否是同一网段

* **如果是同一网段**：放入源ip和目标ip，然后通过ARP获得目标的mac地址，放入mac头中，发出去就行。
* **如果不是同一网段**：就需要获得网关的mac地址，然后发往默认网关。



==路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的IP地址都和局域网的IP地址在相同的网段，每只手都是那个局域网的网关。==



### 静态路由

*静态路由就是在路由器上，配置一条条规则，每次选择从哪个网口出去的时候，就匹配一条条规则，找到下一跳的IPX。*



### IP头和MAC头 哪些变，哪些不变

只要过了网关MAC地址一定会改变。

所谓的下一跳：源地址就是当前路由器的MAC地址，就是路由器根据目的IP地址匹配规则选择新的目的MAC地址。**也就是某个IP要将这个IP地址通过ARP转换为MAC放入到MAC头。**

* **转发网关**：不改变IP地址。
* **NAT网关**：NAT（Network Address Translation）改变IP地址。



## 路由协议



### 策略路由

<img src="D:\project\blog_image\c3f476eb7ce8f185befb6c7a2b1752db.jpg" alt="NAT路由器" style="zoom:12" />



### 动态路由

**距离矢量路由算法**：基于Belman-Ford算法。适用于小型网络（距离小于15的时候）。

缺点：1. 好消息传得快，坏消息传得慢。

​			2. 每次发送的时候，要发送整个全局路由表



**链路状态路由算法**：基于Dijkstra算法。



#### 动态路由协议

**OSPF**：Open Shortest Path First，开放式最短路径优先，基于链路状态路由算法。

**BGP**：Border Gateway Protocol，外网路由协议，使用的是路径矢量路由协议，基于距离矢量路由算法。